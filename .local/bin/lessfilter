#! /usr/bin/env bash

## Debug
# exec 2>>${HOME}/lessfilter.log
#set -x
mime=$(file -Lbs --mime-type "$1")
category=${mime%%/*}
kind=${mime##*/}
ext=${1##*.}
# Use function lessfilter_vars <file> to see values above
# echo "mime: $mime -- category: $category -- kind: $kind -- ext: $ext"
# exit
if [ "$ext" = lua ]; then
    if [ "$(command -v bat)" ]; then
        bat --color=always --language=lua "$1"
    fi
elif [ "$kind" = json ]; then
    if [ "$(command -v jupyter)" ] && [ "$(command -v bat)" ] && [ "$ext" = ipynb ]; then
        jupyter nbconvert --to python --stdout "$1" | bat --color=always -plpython
    elif [ "$(command -v jq)" ]; then
        jq -Cr . "$1"
    fi
elif [ "$kind" = vnd.sqlite3 ]; then
    if [ "$(command -v yes)" ] && [ "$(command -v sqlite3)" ] && [ "$(command -v bat)" ]; then
        yes .q | sqlite3 "$1" | bat --color=always -plsql
    fi
# https://github.com/wofr06/lesspipe/pull/107
elif [ -d "$1" ]; then
    if [ "$(command -v eza)" ]; then
        eza --git -hl --color=always --icons "$1"
    fi
# https://github.com/wofr06/lesspipe/pull/110
elif [ "$kind" = pdf ]; then
    if [ "$(command -v pdftotext)" ] && [ "$(command -v sed)" ]; then
        pdftotext -q "$1" - | sed "s/\f/$(hr â”€)\n/g"
    fi
# https://github.com/wofr06/lesspipe/pull/115
elif [ "$kind" = rfc822 ]; then
    if [ "$(command -v bat)" ]; then
        bat --color=always -lEmail "$1"
    fi
# https://github.com/wofr06/lesspipe/pull/106
elif [ "$category" = image ]; then
    if [ "$(command -v chafa)" ]; then
        chafa -f symbols "$1"
    fi
    if [ "$(command -v exiftool)" ]; then
        exiftool "$1" | bat --color=always -plyaml
    fi
elif [ "$ext" = md ]; then
    if [ "$(command -v glow)" ]; then
        # Since glow is called inside a pipe where term characteristics can't be queried
        # we need to set the style ("dark") https://github.com/wofr06/lesspipe/issues/112
        glow -s "$HOME/.config/glow/catppuccin-macchiato.json" "$1"
        #CLI_COLOR=1 COLORTERM=truecolor glow -s dark
        # CLI_COLOR=1 glow -s dark
        # COLORTERM=truecolor glow -s dark
        # FORCE_COLOR=1 glow -p -s $HOME/.config/glow/catppuccin-macchiato.json "$1"
        # glow -s dark "$1" --style=dark --pager=cat | less -R
        # glow -s dark "$1"
    fi
elif [ "$category" = application ] && [ "$kind" = x-sharedlib ]; then
    if [ "$(command -v readelf)" ] && [ "$(command -v bat)" ]; then
        readelf -a "$1" | bat --color=always -plbash
    fi
elif [ "$category" = application ]; then
    echo kind: $kind
    echo mime: $ext -- category: $category
    echo "Binary file: $1"
    echo
    file -Lbs -- "$1" 2>/dev/null || true
    echo
    stat -- "$1" 2>/dev/null || true
# https://github.com/wofr06/lesspipe/pull/117
elif [ "$category" = text ]; then
    if [ "$(command -v bat)" ]; then
        bat --color=always "$1"
    elif [ "$(command -v pygmentize)" ]; then
        pygmentize "$1" | less
    fi
else
    exit 1
fi
