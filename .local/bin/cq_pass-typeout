#!/usr/bin/env bash
#:usage: cq_pass-typeout [ROFI_ARGS...]
#:no-args: false
#:desc: Type a gopass password and Tab into the active window.

set -euo pipefail

ROFI_THEME="${ROFI_THEME:-$HOME/.local/share/rofi/themes/cq-xps17/cq.rasi}"
ROFI_PROMPT="${ROFI_PROMPT:-gopass (type pass)}"

notify() { command -v notify-send >/dev/null 2>&1 && notify-send -a cqpass "$@"; }

type_pass_tab() {
  local pass="$1"

  if [[ -n "${WAYLAND_DISPLAY-}" ]] && command -v wtype >/dev/null 2>&1; then
    wtype -- "$pass"
    wtype -k Tab
    return 0
  fi

  if [[ -n "${DISPLAY-}" ]] && command -v xdotool >/dev/null 2>&1; then
    xdotool type --clearmodifiers -- "$pass"
    xdotool key Tab
    return 0
  fi

  notify "No typer found" "Need wtype (Wayland) or xdotool (Xorg)"
  return 1
}

pkill -x rofi >/dev/null 2>&1 || true

entries="$({ gopass ls --flat 2>/dev/null || true; })"
if [[ -z "$entries" ]]; then
  notify "gopass has no entries (or failed)" "Is your store available?"
  exit 1
fi

entry="$(printf '%s\n' "$entries" | rofi -dmenu -i -p "$ROFI_PROMPT" -theme "$ROFI_THEME" "$@")"
[[ -n "$entry" ]] || exit 0

secret="$({ gopass show -o -- "$entry" 2>/dev/null || true; })"
pw="$(printf '%s\n' "$secret" | head -n1)"

if [[ -z "$pw" ]]; then
  notify "gopass returned empty" "Agent/pinentry?"
  exit 1
fi

type_pass_tab "$pw"

