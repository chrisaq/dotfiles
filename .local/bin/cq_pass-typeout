#!/usr/bin/env bash
#:usage: cq_pass-typeout
#:no-args: true
#:desc: Type a pass password and tab into the active window.

shopt -s nullglob globstar

# Testing
LOGFILE=$HOME/.cache/cqpass
#echo -e "\t" >>$LOGFILE
#echo -e "cqpass-typeout -- $(date)" >>$LOGFILE
#echo -e "\t$(gpgconf --list-dirs agent-socket)" >>$LOGFILE
#echo -e "\tPASSWORD_STORE_DIR: $PASSWORD_STORE_DIR" >>$LOGFILE
#echo -e "\tGNUPGHOME: $GNUPGHOME" >>$LOGFILE

# get all the saved password files
prefix=${PASSWORD_STORE_DIR-~/Sync/Password-Store}
PASSWORD_STORE_DIR=$prefix
password_files=( "$prefix"/**/*.gpg )
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

# Testing
#echo -e "\tprefix: $prefix" >>$LOGFILE

# shows a list of all password files and saved the selected one in a variable
#password=$(printf '%s\n' "${password_files[@]}" | rofi -dmenu "$@" -theme ~/.local/share/rofi/themes/nord/nord.rasi)
password=$(printf '%s\n' "${password_files[@]}" | rofi -dmenu -p '' "$@" -theme ~/.local/share/rofi/themes/cq-xps17/cq.rasi)
[[ -n $password ]] || exit

pw="$(pass show -- "$password" 2>/dev/null | head -n1 || true)"
[[ -z "$pw" ]] && notify-send -a cqpass "pass returned empty (agent/pinentry?)" && exit 1

# Type password + tab on both Wayland and Xorg.
if [[ -n "${WAYLAND_DISPLAY-}" ]] && command -v wtype >/dev/null 2>&1; then
  wtype -- "$pw"
  wtype -k Tab
elif [[ -n "${DISPLAY-}" ]] && command -v xdotool >/dev/null 2>&1; then
  xdotool type --clearmodifiers -- "$pw"
  xdotool key Tab
else
  notify-send -a cqpass "No typer found (need wtype on Wayland or xdotool on Xorg)" || true
  exit 1
fi
